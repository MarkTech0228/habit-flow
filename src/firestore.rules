rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isValidHabit() {
      let data = request.resource.data;
      return data.title is string 
        && data.title.size() > 0 
        && data.title.size() <= 100
        && data.frequency in ['daily', 'weekly']
        && data.completedDates is list
        && data.completedDates.size() <= 365
        && (data.icon == null || data.icon is string)
        && (data.colorTheme == null || data.colorTheme is string)
        && (data.reminderTime == null || data.reminderTime is string)
        && (data.reminderEnabled == null || data.reminderEnabled is bool);
    }
    
    function isValidTodo() {
      let data = request.resource.data;
      return data.title is string 
        && data.title.size() > 0 
        && data.title.size() <= 200
        && data.completed is bool
        && (data.priority == null || data.priority in ['low', 'medium', 'high'])
        && (data.dueDate == null || data.dueDate is string);
    }
    
    function isValidExpense() {
    let data = request.resource.data;
    return data.date is string
    && data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$')
    && data.amount is number
    && data.amount > 0
    && data.amount <= 1000000
    && data.category is string
    && data.category in ['food', 'transport', 'entertainment', 'shopping', 'bills', 'health', 'debt_payment', 'other']
    && data.description is string
    && data.description.size() <= 500
    // ✅ Allow optional fields
    && (!data.keys().hasAny(['receiptImage']) || data.receiptImage is string)
    && (!data.keys().hasAny(['createdAt']) || data.createdAt is timestamp);
}
    
    function isValidMoneySettings() {
      let data = request.resource.data;
      return data.dailyAllowance is number
        && data.dailyAllowance >= 0
        && data.dailyAllowance <= 100000
        && data.currency is string
        && data.currency.size() == 3
        && data.currencySymbol is string
        && data.currencySymbol.size() <= 5;
    }
    
    function isValidDebt() {
      let data = request.resource.data;
      return data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        && data.balance is number
        && data.balance >= 0
        && data.balance <= 10000000
        && data.interestRate is number
        && data.interestRate >= 0
        && data.interestRate <= 100
        && data.minimumPayment is number
        && data.minimumPayment >= 0
        && data.minimumPayment <= 100000
        && data.type in ['credit_card', 'student_loan', 'mortgage', 'personal_loan', 'other']
        && data.dueDay is int
        && data.dueDay >= 1
        && data.dueDay <= 31;
    }
    
    function isValidIncome() {
      let data = request.resource.data;
      return data.date is string
        && data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$')
        && data.amount is number
        && data.amount > 0
        && data.amount <= 10000000
        && data.source is string
        && data.source.size() > 0
        && data.source.size() <= 100
        && data.description is string
        && data.description.size() <= 500;
    }
    
    function isValidSavingsGoal() {
      let data = request.resource.data;
      return data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        && data.targetAmount is number
        && data.targetAmount > 0
        && data.targetAmount <= 10000000
        && data.currentAmount is number
        && data.currentAmount >= 0
        && data.deadline is string
        && data.deadline.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
    }
    
    function isValidRecurringExpense() {
      let data = request.resource.data;
      return data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        && data.amount is number
        && data.amount > 0
        && data.amount <= 100000
        && data.category is string
        && data.frequency in ['daily', 'weekly', 'monthly', 'yearly']
        && data.startDate is string
        && data.startDate.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$')
        && data.nextPaymentDate is string
        && data.nextPaymentDate.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$')
        && data.reminderEnabled is bool
        && data.reminderDaysBefore is int
        && data.reminderDaysBefore >= 0
        && data.reminderDaysBefore <= 30
        && data.isActive is bool;
    }
    
    function isValidInvestment() {
      let data = request.resource.data;
      return data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        && data.type in ['stocks', 'crypto', 'bonds', 'real_estate', 'retirement', 'other']
        && data.amount is number
        && data.amount > 0
        && data.amount <= 10000000
        && data.purchasePrice is number
        && data.purchasePrice > 0
        && data.currentPrice is number
        && data.currentPrice >= 0
        && data.purchaseDate is string
        && data.purchaseDate.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
    }
    
    // ============================================
    // USER RULES
    // ============================================
    
    match /users/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() 
        && isOwner(userId)
        && request.resource.data.username is string
        && request.resource.data.email is string;
      allow update: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/profile/{document=**} {
      allow read: if isSignedIn() && isOwner(userId);
      allow write: if isSignedIn() && isOwner(userId);
    }
    
    // ============================================
    // HABITS RULES (✅ FIXED)
    // ============================================
    
    match /users/{userId}/habits/{habitId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidHabit();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    // ============================================
    // TODOS RULES
    // ============================================
    
    match /users/{userId}/todos/{todoId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidTodo();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    // ============================================
    // MONEY TRACKING RULES
    // ============================================
    
    match /users/{userId}/money/settings {
      allow read: if isSignedIn() && isOwner(userId);
      allow write: if isSignedIn() && isOwner(userId) && isValidMoneySettings();
    }
    
    match /users/{userId}/expenses/{expenseId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidExpense();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/incomes/{incomeId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidIncome();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/debts/{debtId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidDebt();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/savingsGoals/{goalId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidSavingsGoal();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/recurringExpenses/{recurringId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidRecurringExpense();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/investments/{investmentId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && isValidInvestment();
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/debtPayments/{paymentId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    match /users/{userId}/budgets/{categoryId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow write: if isSignedIn() && isOwner(userId);
    }
    
    // ============================================
    // VERIFICATION CODES
    // ============================================
    
    match /verificationCodes/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() 
        && isOwner(userId)
        && request.resource.data.code is string
        && request.resource.data.code.size() == 6
        && request.resource.data.email is string;
      allow delete: if isSignedIn() && isOwner(userId);
    }
    
    // ============================================
    // USERNAME RESERVATION
    // ============================================
    
    match /usernames/{username} {
      allow read: if true;
      allow create: if isSignedIn() 
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.originalUsername is string
        && request.resource.data.originalUsername.size() >= 3
        && request.resource.data.originalUsername.size() <= 30
        && request.resource.data.originalUsername.matches('^[a-zA-Z0-9_]+$');
      allow update: if false;
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}